# üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Karpenter

## 1. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

–ü–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å —É–∂–µ —Å–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Ç–µ—Ä –≤ **Managed Kubernetes**.

–†–µ–∫–æ–º–µ–¥—É–µ—Ç—Å—è –∏c–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä —Å –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∞–≤—Ç–æ—Å–∫–µ–π–ª–∞ –∏ –∞–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ Karpenter —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–æ–¥.

üìò –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä:
https://docs.selectel.ru/managed-kubernetes/create/create-cloud-cluster/

- Kubernetes –≤–µ—Ä—Å–∏–∏ **1.28+**
- Karpenter –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∫ pod, –ø–æ—ç—Ç–æ–º—É –µ–º—É –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã —Ä–µ—Å—É—Ä—Å—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ  
  üîß –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
  - –æ–¥–Ω–∞ –Ω–æ–¥–∞ —Å **2 vCPU** –∏ **4 GiB RAM** –¥–ª—è Karpenter

  üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
  - –¥–≤–µ –Ω–æ–¥—ã —Å **2 vCPU** –∏ **4 GiB RAM** –¥–ª—è Karpenter 
  - –∫–ª–∞—Å—Ç–µ—Ä —Å –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∞–≤—Ç–æ—Å–∫–µ–π–ª–∞ –∏ –∞–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

‚ö†Ô∏è –í–∞–∂–Ω–æ:
Karpenter –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–¥–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω —Å–∞–º –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª.

---

## 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞

karpenter-provider-selectel - —ç—Ç–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä Karpenter –¥–ª—è Selectel Managed Kubernetes.
–û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç core-—á–∞—Å—Ç—å Karpenter –≤–µ—Ä—Å–∏–∏ v1.7.1.

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Karpenter —á–µ—Ä–µ–∑ helm:

```bash
helm install karpenter-helmrelease oci://ghcr.io/selectel/mks-charts/karpenter:0.1.0 \
--namespace kube-system \
--set controller.settings.clusterID=$CLUSTER_ID
```

> CLUSTER_ID - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–∞—à–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ Managed Kubernetes. –ú–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –≤–∞—à–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∏–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å —Å—Ç—Ä–æ–∫—É c –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –Ω–∞–ø—Ä—è–º—É—é –≤ –∫–æ–º–∞–Ω–¥–µ helm install.

---

## 3. –°–æ–∑–¥–∞–Ω–∏–µ NodeClass (nodeclass.yaml)

–î–ª—è –Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é **—Å–µ—Ç–µ–≤—ã—Ö –¥–∏—Å–∫–æ–≤**, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –Ω–æ–¥–∞–º–∏ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ.  
`NodeClass` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–∏—Å–∫–æ–≤.  
–í –æ–¥–Ω–æ–º –∫–ª–∞—Å—Ç–µ—Ä–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ `NodeClass`, –æ—Ç–ª–∏—á–∞—é—â–∏—Ö—Å—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∏–ø–æ–º –∏–ª–∏ —Ä–∞–∑–º–µ—Ä–æ–º –¥–∏—Å–∫–∞.

**–°–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ –¥–∏—Å–∫–æ–≤:**  
<https://docs.selectel.ru/cloud-servers/volumes/about-network-volumes/#network-volume-types-list>

#### –ü—Ä–∏–º–µ—Ä `NodeClass`

```yaml
apiVersion: karpenter.k8s.selectel/v1alpha1
kind: SelectelNodeClass
metadata:
  name: default
spec:
  disk:
    # –¢–∏–ø (–∫–∞—Ç–µ–≥–æ—Ä–∏—è) —Å–µ—Ç–µ–≤–æ–≥–æ –¥–∏—Å–∫–∞
    categories:
      - universal
    # –†–∞–∑–º–µ—Ä –¥–∏—Å–∫–∞ –≤ GiB
    sizeGiB: 30
```

---

## 4. –°–æ–∑–¥–∞–Ω–∏–µ NodePool

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `NodeClass` –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å **NodePool** ‚Äî –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–¥–±–æ—Ä–∞ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–¥.

Karpenter –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `NodePool`, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å:
- –∫–∞–∫–∏–µ —Ç–∏–ø—ã –Ω–æ–¥ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å,
- —Å –∫–∞–∫–∏–º–∏ —Ñ–ª–µ–π–≤–æ—Ä–∞–º–∏ –∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏,
- –∏ –∫–æ–≥–¥–∞ —ç—Ç–∏ –Ω–æ–¥—ã –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å.

–ö–∞–∂–¥—ã–π `NodePool` —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π `NodeClass`, –≥–¥–µ —É–∫–∞–∑–∞–Ω—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.

#### –ü—Ä–∏–º–µ—Ä `NodePool` (nodepool.yaml)

```yaml
apiVersion: karpenter.sh/v1
kind: NodePool
metadata:
  name: default
spec:
  template:
    spec:
      # –°—Å—ã–ª–∫–∞ –Ω–∞ NodeClass
      nodeClassRef:
        name: default
        kind: SelectelNodeClass
        group: karpenter.k8s.selectel
      # –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è (—Ñ–∏–ª—å—Ç—Ä—ã) –¥–ª—è —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö –Ω–æ–¥
      requirements:
        # –°–µ–≥–º–µ–Ω—Ç—ã –ø—É–ª–∞, –≥–¥–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–¥—ã
        - key: topology.kubernetes.io/zone
          operator: In
          values: ["ru-7a", "ru-7b"]
        # –î–æ–ø—É—Å—Ç–∏–º—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (flavors) –∏–∑ –æ–±–ª–∞–∫–∞
        - key: node.kubernetes.io/instance-type
          operator: In
          values: ["SL1.1-2048", "SL1.2-4096", "SL1.2-8192"]
        # –¢–∏–ø —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö –Ω–æ–¥ (on-demand, spot)
        - key: karpenter.sh/capacity-type
          operator: In
          values: ["on-demand"]
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ "–∂–∏–∑–Ω–∏" –Ω–æ–¥
  disruption:
    # WhenEmptyOrUnderutilized ‚Äî —É–¥–∞–ª—è—Ç—å –∏–ª–∏ –∑–∞–º–µ–Ω—è—Ç—å –Ω–æ–¥—ã, –µ—Å–ª–∏ –æ–Ω–∏ –ø—É—Å—Ç—ã–µ –∏–ª–∏ –Ω–µ–¥–æ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
    consolidationPolicy: WhenEmptyOrUnderutilized
    # –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–µ–π –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
    consolidateAfter: 0s
    # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –Ω–æ–¥—ã (30 –¥–Ω–µ–π)
    expireAfter: 720h
  # –û–±—â–∏–µ –ª–∏–º–∏—Ç—ã –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã –ø—É–ª–∞
  limits:
    cpu: "1000"       # –ú–∞–∫—Å–∏–º—É–º 1000 vCPU –Ω–∞ –≤—Å–µ –Ω–æ–¥—ã –ø—É–ª–∞
    memory: 1000Gi    # –ú–∞–∫—Å–∏–º—É–º 1000 GiB –ø–∞–º—è—Ç–∏
```

**–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ NodePool:** <https://karpenter.sh/docs/concepts/nodepools/>

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ

```bash
kubectl apply -f nodeclass.yaml
kubectl apply -f nodepool.yaml
```

---

## 5. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–ª—é—á–∏ –≤ `requirements`

–ü–æ –≤—Å–µ–º —ç—Ç–∏–º –∫–ª—é—á–∞–º –º–æ–∂–Ω–æ **—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å** –ø–æ–¥–±–æ—Ä –Ω–æ–¥ –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏.  
Karpenter –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Ö –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ç–∏–ø–æ–≤ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ (flavors) –ø–æ–¥ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–æ–¥–æ–≤.

| –ö–ª—é—á | –ü—Ä–∏–º–µ—Ä –∑–Ω–∞—á–µ–Ω–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|---|---|
| **karpenter.sh/capacity-type** | `["on-demand"]`, `["spot"]` | –¢–∏–ø —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö –Ω–æ–¥ ‚Äî on-demand (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ) –∏–ª–∏ spot (–ø—Ä–µ—Ä—ã–≤–∞–µ–º—ã–µ). |
| **karpenter.k8s.selectel/instance-category** | `["SL", "GL"]` | –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏–Ω—Å—Ç–∞–Ω—Å–∞ (Standard Line, GPU Line –∏ —Ç. –¥.). –ü–æ–¥—Ä–æ–±–Ω–µ–µ: <https://docs.selectel.ru/cloud-servers/create/configurations/#server-flavors-list> |
| **karpenter.k8s.selectel/instance-family** | `["SL1", "GL1"]` | –°–µ–º–µ–π—Å—Ç–≤–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ (–ª–∏–Ω–µ–π–∫–∞). |
| **karpenter.k8s.selectel/instance-generation** | `["1", "2"]` | –ü–æ–∫–æ–ª–µ–Ω–∏–µ —Å–µ–º–µ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Ç–æ—Ä–æ–µ –ø–æ–∫–æ–ª–µ–Ω–∏–µ). |
| **karpenter.k8s.selectel/instance-cpu** | `Gt: "4"` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ vCPU (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–æ–ª—å—à–µ 4). |
| **karpenter.k8s.selectel/instance-memory** | `Gt: "8"` | –û–±—ä–µ–º –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (GiB). |
| **karpenter.k8s.selectel/instance-gpu-name** | `["A100", "H100"]` | –ù–∞–∑–≤–∞–Ω–∏–µ GPU (–¥–ª—è GPU-–∏–Ω—Å—Ç–∞–Ω—Å–æ–≤). –ü–æ–¥—Ä–æ–±–Ω–µ–µ: <https://docs.selectel.ru/cloud-servers/create/gpus/> |
| **karpenter.k8s.selectel/instance-gpu-manufacturer** | `["NVIDIA"]` | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å GPU. |
| **karpenter.k8s.selectel/instance-gpu-count** | `Gt: "0"` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ GPU (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã). |
| **karpenter.k8s.selectel/instance-local-disk** | `["true"]`, `["false"]` | –ù–∞–ª–∏—á–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–∏—Å–∫–∞ (NVMe/SSD). |

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
- –°–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ GPU-–Ω–æ–¥—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –æ–¥–Ω–æ–π –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã.
- –ò—Å–∫–ª—é—á–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–∫–æ–ª–µ–Ω–∏—è, –∑–∞–¥–∞–≤ `instance-generation > 1`.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å—ã —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –¥–∏—Å–∫–æ–º.

---

## 6. –ì–æ—Ç–æ–≤–æ

–¢–µ–ø–µ—Ä—å Karpenter –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.  
–ü–æ—Å–ª–µ –ø–æ—è–≤–ª–µ–Ω–∏—è –ø–æ–¥–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤, Karpenter –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–¥—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —É—Å–ª–æ–≤–∏—è–º –∏–∑ `NodePool` + `NodeClass`.
